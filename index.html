<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My List Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; background: #f6f8fa; color: #222; margin: 0; padding: 0; }
    #app { max-width: 900px; margin: 32px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 32px;}
    h1 { margin-top: 0; }
    .top-bar { display: flex; align-items: center; margin-bottom: 14px; }
    .grok-btn {
      display:inline-block; margin-right:16px; padding:6px 18px; border-radius:6px;
      background: #222; color: #fff; text-decoration: none; font-weight: bold; font-size: 1em; border: none; cursor: pointer;
      transition: background 0.15s;
    }
    .grok-btn:hover { background: #0366d6; color:#fff; }
    .list-tabs {margin-bottom:16px;}
    .list-tab {margin-right:6px; padding:4px 10px; border-radius:6px; border:none; background:#e3e6ea; cursor:pointer;}
    .list-tab.active {background:#0366d6; color:#fff;}
    .list-tab .del-list {margin-left:5px; color:#a00; cursor:pointer;}
    .list-title {font-size:1.3em; font-weight:bold;padding:6px 0;margin-bottom:8px;width:100%;border:1px solid #ddd; border-radius:4px;}
    table {width:100%;border-collapse:collapse;margin-bottom:8px;}
    th, td {border:1px solid #ddd;padding:6px;}
    th {background:#f1f5fa;}
    tr.dragging {background: #f3f3f3;}
    tr:hover:not(.dragging) {background:#f9fafc;}
    .actions {text-align:right;}
    .item-del {color:#b00; background:none; border:none; cursor:pointer;}
    .item-move {cursor:grab;}
    .token-area {margin-bottom:14px;}
    .save-status {float:right; font-size:0.95em; color:#888;}
    .add-row-btn, .add-list-btn {margin-top:8px;}
    input[type="text"] {width:98%; box-sizing:border-box;}
    #tokenCheckBtn {margin-left:8px;}
    #rememberToken {margin-left:8px;}
    .item-img-preview {width:38px; height:38px; object-fit:cover; border-radius:4px; border:1px solid #ddd; margin-right:4px; cursor:pointer;}
    .img-upload-wrap {display:flex; align-items:center;}
    .img-upload-label { cursor: pointer; color: #0366d6; margin-left: 4px;}
    .img-upload-progress { margin-left: 6px; font-size:0.95em; color: #888;}
    /* Modal Styles */
    .modal-bg {
      display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.66); z-index:1001; align-items:center; justify-content:center;
    }
    .modal-bg.active {display:flex;}
    .modal-img-wrap {
      background: #fff; border-radius: 8px; box-shadow: 0 2px 16px #0008; max-width:90vw; max-height:90vh; padding:10px; position:relative;
      display: flex; flex-direction: column; align-items: center;
    }
    .modal-img {max-width:80vw; max-height:75vh; border-radius:6px;}
    .modal-close-btn {
      position: absolute; top: 8px; right: 12px; background: #fff; border: none; font-size: 1.7em; color: #333; cursor: pointer; line-height: 1;
    }
    @media (max-width:600px) {
      #app {padding:8px;}
      table, th, td {font-size:13px;}
      .list-title {font-size:1em;}
      .top-bar { flex-direction: column; align-items: flex-start;}
      .grok-btn { margin-bottom: 8px; }
      .img-upload-wrap { flex-direction: column; align-items:flex-start;}
      .item-img-preview { margin-bottom:4px; }
      .modal-img {max-width:95vw; max-height:70vh;}
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="top-bar">
      <a class="grok-btn" href="https://grok.com/" target="_blank">Go to Grok</a>
      <h1 style="margin:0;flex:1 0 auto;">
        My List Manager
        <span class="save-status" id="saveStatus">Loading...</span>
      </h1>
    </div>
    <div class="token-area" id="tokenArea">
      <label>GitHub Token:
        <input type="password" id="tokenInput" placeholder="Enter your GitHub token" size="40">
      </label>
      <button id="tokenSetBtn">Set</button>
      <button id="tokenCheckBtn">Check Token</button>
      <label id="rememberLabel" style="display:none;">
        <input type="checkbox" id="rememberToken" checked> Remember
      </label>
      <span id="tokenInfo" style="color:#888;font-size:0.95em"></span>
    </div>
    <div>
      <div class="list-tabs" id="listTabs"></div>
      <button class="add-list-btn" id="addListBtn">+ Add List</button>
    </div>
    <div id="listArea" style="display:none;">
      <input class="list-title" id="listTitle">
      <table id="itemTable">
        <thead>
          <tr>
            <th style="width:16%;">Item</th>
            <th style="width:12%;">Image</th>
            <th style="width:26%;">web</th>
            <th style="width:10%;">price</th>
            <th style="width:23%;">P.S.</th>
            <th style="width:13%;">Actions</th>
          </tr>
        </thead>
        <tbody id="itemRows"></tbody>
      </table>
      <button class="add-row-btn" id="addItemBtn">+ Add Item</button>
    </div>
    <!-- Modal for big image view -->
    <div class="modal-bg" id="imgModalBg" onclick="closeImgModal(event)">
      <div class="modal-img-wrap">
        <button class="modal-close-btn" onclick="closeImgModal(event)">&times;</button>
        <img class="modal-img" id="imgModalImg" src="" alt="Big image">
      </div>
    </div>
  </div>
  <script>
  // --- CONFIG ---
  const OWNER = 'lhwongn-bot';
  const REPO = 'My-list';
  const BRANCH = 'main';
  const FILE = 'lists.json';
  const IMAGES_FOLDER = 'images'; // image files will be stored in /images

  // --- STATE ---
  let ghToken = '';
  let lists = []; // [{title,items:[{Item,web,price,P.S.,img}]}], img is image filename or URL
  let currentList = 0;
  let fileSha = null;
  let saveTimer = null;
  let imageUploadProgress = {}; // {itemIdx: string}

  // --- UI HANDLERS ---
  function qs(id){return document.getElementById(id);}
  function setStatus(txt){ qs('saveStatus').innerText = txt;}
  function escapeHtml(str){return (str+'').replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));}

  function renderTabs(){
    const tabs = lists.map((l,idx) =>
      `<button class="list-tab${idx===currentList?' active':''}" onclick="showList(${idx})">
        ${escapeHtml(l.title||'Untitled')}
        <span class="del-list" onclick="event.stopPropagation();deleteList(${idx})">&times;</span>
      </button>`
    ).join('');
    qs('listTabs').innerHTML = tabs;
  }

  function renderList(){
    if(!lists[currentList]){qs('listArea').style.display='none';return;}
    qs('listArea').style.display='block';
    qs('listTitle').value = lists[currentList].title||'';
    renderRows();
  }

  function getImageRawUrl(filename) {
    // https://raw.githubusercontent.com/{OWNER}/{REPO}/{BRANCH}/images/{filename}
    if (!filename) return '';
    if (/^https?:\/\//.test(filename)) return filename; // user-pasted url
    return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${IMAGES_FOLDER}/${encodeURIComponent(filename)}`;
  }

  function renderRows(){
    const items = lists[currentList].items;
    qs('itemRows').innerHTML = items.map((it,idx)=>{
      let imgUrl = it.img ? getImageRawUrl(it.img) : '';
      return `
      <tr draggable="true" ondragstart="startDrag(${idx})" ondragover="dragOver(event,${idx})" ondrop="dropDrag(${idx})" ondragend="endDrag()">
        <td><input type="text" value="${escapeHtml(it.Item)}" onchange="editItem(${idx},'Item',this.value)"></td>
        <td>
          <div class="img-upload-wrap">
            ${imgUrl ? `<img class="item-img-preview" src="${escapeHtml(imgUrl)}" alt="img" onclick="openImgModal('${escapeHtml(imgUrl)}')" onerror="this.src='';">` : ''}
            <input type="file" accept="image/*" style="display:none;" id="itemImgUpload${idx}" onchange="handleImageUpload(event,${idx})">
            <label class="img-upload-label" for="itemImgUpload${idx}">${it.img ? 'Change Image' : 'Upload Image'}</label>
            ${it.img ? `<button onclick="clearItemImage(${idx})" title="Remove Image" style="margin-left:4px;">üóëÔ∏è</button>` : ''}
            <span class="img-upload-progress" id="imgUploadProgress${idx}">${imageUploadProgress[idx]||''}</span>
          </div>
        </td>
        <td><input type="text" value="${escapeHtml(it.web)}" onchange="editItem(${idx},'web',this.value)"></td>
        <td><input type="text" value="${escapeHtml(it.price)}" onchange="editItem(${idx},'price',this.value)"></td>
        <td><input type="text" value="${escapeHtml(it['P.S.'])}" onchange="editItem(${idx},'P.S.',this.value)"></td>
        <td class="actions">
          <button class="item-del" onclick="deleteItem(${idx})">&times;</button>
          <span class="item-move" title="Drag">&#x2630;</span>
        </td>
      </tr>`;
    }).join('');
  }

  // --- IMAGE MODAL VIEW ---
  window.openImgModal = function(imgUrl) {
    const modalBg = qs('imgModalBg');
    const modalImg = qs('imgModalImg');
    modalImg.src = imgUrl;
    modalBg.classList.add('active');
  };
  window.closeImgModal = function(e) {
    // Only close if click background or close btn
    if(!e || e.target === qs('imgModalBg') || e.target.classList.contains('modal-close-btn')){
      qs('imgModalBg').classList.remove('active');
      qs('imgModalImg').src = '';
    }
  };

  // --- LIST LOGIC ---
  window.showList = function(idx){
    saveIfDirty();
    currentList=idx;
    renderTabs();renderList();
  }
  window.deleteList = function(idx){
    if(!confirm('Delete this list?'))return;
    lists.splice(idx,1);
    if(currentList>=lists.length)currentList=lists.length-1;
    renderTabs();renderList(); queueSave();
  }
  qs('addListBtn').onclick = function(){
    saveIfDirty();
    lists.push({title:'New List',items:[]});
    currentList=lists.length-1;
    renderTabs();renderList(); queueSave();
  }
  qs('listTitle').onchange = function(){
    lists[currentList].title=this.value; queueSave();
    renderTabs();
  }

  // --- ITEM LOGIC ---
  window.editItem = function(idx,col,val){
    lists[currentList].items[idx][col]=val; queueSave();
  }
  window.deleteItem = function(idx){
    lists[currentList].items.splice(idx,1); renderRows(); queueSave();
  }
  qs('addItemBtn').onclick = function(){
    lists[currentList].items.push({Item:'',web:'',price:'',"P.S.":'',img:''});
    renderRows(); queueSave();
  }

  // --- IMAGE LOGIC ---
  window.handleImageUpload = async function(e, idx) {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 8*1024*1024) {
      imageUploadProgress[idx] = "Image too large (max 8MB)";
      renderRows();
      return;
    }
    imageUploadProgress[idx] = "Uploading...";
    renderRows();

    // Generate a unique filename (itemidx-timestamp-originalname)
    const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
    const filename = `${Date.now()}_${idx}_${safeName}`;
    // Read as base64
    const reader = new FileReader();
    reader.onload = async function(evt){
      let contentBase64 = evt.target.result.split(',')[1];
      // Upload to GitHub
      try {
        const uploadRes = await uploadImageToGitHub(filename, contentBase64, file.type);
        if (uploadRes.ok) {
          lists[currentList].items[idx].img = filename;
          imageUploadProgress[idx] = "Uploaded";
          renderRows();
          queueSave();
        } else {
          const msg = uploadRes.error || "Upload failed";
          imageUploadProgress[idx] = msg;
          renderRows();
        }
      } catch(ex) {
        imageUploadProgress[idx] = "Error uploading";
        renderRows();
      }
    };
    reader.readAsDataURL(file);
  };

  async function uploadImageToGitHub(filename, contentBase64, mime) {
    // Try to get SHA if file exists
    let imgSha = undefined;
    try {
      const getRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${IMAGES_FOLDER}/${encodeURIComponent(filename)}?ref=${BRANCH}`, {
        headers: getHeaders()
      });
      if (getRes.ok) {
        const getJson = await getRes.json();
        imgSha = getJson.sha;
      }
    } catch (e) {}
    // Now upload
    try {
      const putRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${IMAGES_FOLDER}/${encodeURIComponent(filename)}`, {
        method: "PUT",
        headers: getHeaders(true),
        body: JSON.stringify({
          message: `Upload image ${filename}`,
          content: contentBase64,
          branch: BRANCH,
          sha: imgSha
        })
      });
      if (!putRes.ok) {
        const errJson = await putRes.json();
        return {ok:false, error: errJson.message || "Upload failed"};
      }
      return {ok:true};
    } catch (e) {
      return {ok:false, error: "Upload error"};
    }
  }

  window.clearItemImage = function(idx) {
    lists[currentList].items[idx].img = '';
    renderRows();
    queueSave();
  };

  // --- DRAG & DROP ---
  let dragIdx = null;
  window.startDrag = function(idx){dragIdx=idx; event.currentTarget.classList.add('dragging');}
  window.dragOver = function(e,idx){e.preventDefault();}
  window.dropDrag = function(idx){
    if(dragIdx===null)return;
    const arr=lists[currentList].items;
    const [moved]=arr.splice(dragIdx,1);
    arr.splice(idx,0,moved);
    renderRows(); queueSave();
    dragIdx=null;
  }
  window.endDrag = function(){[].forEach.call(document.querySelectorAll('tr'),tr=>tr.classList.remove('dragging'));}

  // --- GITHUB API ---
  function getHeaders(isPut){
    return {
      'Authorization': 'token '+ghToken,
      'Accept': 'application/vnd.github+json',
      ...(isPut ? {'Content-Type':'application/json'} : {})
    };
  }

  // Unicode safe base64 for JSON (Chinese/UTF-8 support)
  function base64EncodeUnicode(str) {
    return btoa(encodeURIComponent(str));
  }
  function base64DecodeUnicode(str) {
    return decodeURIComponent(atob(str));
  }

  async function fetchLists(){
    if (!ghToken) {
      setStatus('Token required');
      return;
    }
    setStatus('Loading...');
    try{
      const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE}?ref=${BRANCH}`,{
        headers: getHeaders()
      });
      if(r.status===404){
        // File doesn't exist yet; start empty
        lists=[{title:'Sample List',items:[]}]; fileSha=null;
        setStatus('New file'); saveLists(true); // Save initial file
        return;
      }
      const j = await r.json();
      fileSha = j.sha;
      lists = JSON.parse(base64DecodeUnicode(j.content)); // Unicode safe!
      // Ensure old lists without img field are compatible
      for(const l of lists){
        for(const it of l.items) if(typeof it.img === 'undefined') it.img = '';
      }
      if(!Array.isArray(lists)) lists=[{title:'Sample List',items:[]}];
      setStatus('Loaded');
    }catch(e){
      setStatus('Failed to load lists');
      alert('Error loading lists: '+e);
      lists=[{title:'Sample List',items:[]}];
    }
    renderTabs(); renderList();
  }

  async function saveLists(isInit){
    setStatus('Saving...');
    try{
      const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE}`,{
        method:'PUT',
        headers: getHeaders(true),
        body: JSON.stringify({
          message: isInit?'Create lists.json':'Update lists.json',
          content: base64EncodeUnicode(JSON.stringify(lists,null,2)), // Unicode safe!
          branch: BRANCH,
          sha: fileSha||undefined
        })
      });
      const resp = await res.json();
      if(resp && resp.content && resp.content.sha){
        fileSha=resp.content.sha;
        setStatus('Saved');
      }else{
        throw new Error(resp.message||'Unknown error');
      }
    }catch(e){
      setStatus('Save failed');
      alert('Failed to save: '+e);
    }
  }

  function queueSave(){
    setStatus('Saving...');
    if(saveTimer)clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>saveLists(false), 900);
  }
  function saveIfDirty(){
    if(saveTimer) { clearTimeout(saveTimer); saveLists(false);}
  }

  // --- TOKEN LOGIC ---
  function setToken(token) {
    ghToken = token;
    localStorage.setItem('gh_token', token);
    sessionStorage.removeItem('gh_token');
    qs('tokenArea').style.display = '';
    fetchLists();
  }

  // Load token if saved (ALWAYS remember on set, so always use localStorage)
  (function loadSavedToken(){
    let stored = localStorage.getItem('gh_token') || sessionStorage.getItem('gh_token');
    if(stored){
      qs('tokenInput').value = stored;
      ghToken = stored;
      fetchLists();
    }
  })();

  qs('tokenSetBtn').onclick = function(){
    const token = qs('tokenInput').value.trim();
    if(token) setToken(token);
    else alert('Please enter a valid GitHub token');
  };

  // --- Token Check Function ---
  qs('tokenCheckBtn').onclick = async function(){
    const token = qs('tokenInput').value.trim();
    if (!token) {
      qs('tokenInfo').innerText = "Please enter a token first.";
      return;
    }
    qs('tokenInfo').innerText = "Checking token...";
    try {
      const resp = await fetch('https://api.github.com/user', {
        headers: {
          'Authorization': 'token ' + token,
          'Accept': 'application/vnd.github+json'
        }
      });
      if (resp.ok) {
        const user = await resp.json();
        qs('tokenInfo').innerText = "Valid token: " + user.login;
      } else {
        qs('tokenInfo').innerText = "Invalid token or insufficient permissions";
      }
    } catch (e) {
      qs('tokenInfo').innerText = "Network error";
    }
  };

  // Expose for HTML event handlers
  window.showList = window.showList;
  window.deleteList = window.deleteList;
  window.editItem = window.editItem;
  window.deleteItem = window.deleteItem;
  window.startDrag = window.startDrag;
  window.dragOver = window.dragOver;
  window.dropDrag = window.dropDrag;
  window.endDrag = window.endDrag;
  window.handleImageUpload = window.handleImageUpload;
  window.clearItemImage = window.clearItemImage;
  window.openImgModal = window.openImgModal;
  window.closeImgModal = window.closeImgModal;
  </script>
</body>
</html>